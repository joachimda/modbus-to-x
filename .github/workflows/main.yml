name: Release OTA
on:
  push:
    tags:
      - "v*"

permissions:
  contents: write
jobs:
  build_sign_release:
    runs-on: ubuntu-latest
    env:
      PROJECT_DIR: software/modbus-to-mqtt
      PIO_ENV: prod-board-v0-1-alpha
      DEVICE: modbus-to-x
      KID: "bd774d27-badf-48a3-b927-a51fb08629f7"

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install PlatformIO
        run: pip install -U platformio

      - name: Set version from tag
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "APP_VERSION=$VERSION" >> $GITHUB_ENV

      - name: Build firmware
        run: pio run --project-dir "${PROJECT_DIR}" -e "${PIO_ENV}"
      - name: Build filesystem image (buildfs)
        run: pio run --project-dir "${PROJECT_DIR}" -e "${PIO_ENV}" -t buildfs
      - name: Prepare assets + sha256
        run: |
          APP_BIN="${PROJECT_DIR}/.pio/build/${PIO_ENV}/firmware.bin"
          cp "$APP_BIN" "${DEVICE}.bin"
          APP_SHA256="$(sha256sum "${DEVICE}.bin" | awk '{print $1}')"
          echo "APP_SHA256=$APP_SHA256" >> $GITHUB_ENV

          FS_BIN_SPIFFS="${PROJECT_DIR}/.pio/build/${PIO_ENV}/spiffs.bin"
          FS_BIN_LITTLEFS="${PROJECT_DIR}/.pio/build/${PIO_ENV}/littlefs.bin"

          if [ -f "$FS_BIN_SPIFFS" ]; then
            cp "$FS_BIN_SPIFFS" "${DEVICE}.fs.bin"
          elif [ -f "$FS_BIN_LITTLEFS" ]; then
            cp "$FS_BIN_LITTLEFS" "${DEVICE}.fs.bin"
          else
            echo "No filesystem image found (spiffs.bin/littlefs.bin). Did buildfs run?" >&2
            ls -la "${PROJECT_DIR}/.pio/build/${PIO_ENV}" || true
            exit 1
          fi

          FS_SHA256="$(sha256sum "${DEVICE}.fs.bin" | awk '{print $1}')"
          echo "FS_SHA256=$FS_SHA256" >> $GITHUB_ENV
      - name: Load signing key
        run: |
          printf "%s" "${{ secrets.OTA_SIGNING_KEY_PEM }}" > ota_signing.key
          chmod 600 ota_signing.key

      - name: Create manifest and signature
        run: |
          APP_URL="https://github.com/${GITHUB_REPOSITORY}/releases/download/v${VERSION}/${DEVICE}.bin"
          FS_URL="https://github.com/${GITHUB_REPOSITORY}/releases/download/v${VERSION}/${DEVICE}.fs.bin"
          FS_LABEL="spiffs"   # <- your UI partition label

          PAYLOAD="${DEVICE}|${VERSION}|${APP_SHA256}|${APP_URL}|${FS_LABEL}|${FS_SHA256}|${FS_URL}|${KID}"
          printf "%s" "$PAYLOAD" > payload.txt

          openssl dgst -sha256 -sign ota_signing.key -out sig.bin payload.txt
          SIG_B64="$(base64 -w0 sig.bin)"

          cat > "${DEVICE}.manifest.json" <<EOF
          {
            "device": "${DEVICE}",
            "version": "${VERSION}",
            "kid": "${KID}",
            "app": { "url": "${APP_URL}", "sha256": "${APP_SHA256}" },
            "fs":  { "label": "${FS_LABEL}", "url": "${FS_URL}", "sha256": "${FS_SHA256}" },
            "sig": "${SIG_B64}"
          }
          EOF
      - name: Create GitHub Release + upload assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PRERELEASE=""
          if [[ "${VERSION}" == *"-"* ]]; then
            PRERELEASE="--prerelease"
          fi

          gh release create "v${VERSION}" \
            --title "v${VERSION}" \
            --generate-notes \
            "${DEVICE}.bin" \
            "${DEVICE}.fs.bin" \
            "${DEVICE}.manifest.json"
