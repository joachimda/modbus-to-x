name: Release OTA
on:
  push:
    tags:
      - "v*"

permissions:
  contents: write
jobs:
  build_sign_release:
    runs-on: ubuntu-latest
    env:
      PROJECT_DIR: software/modbus-to-mqtt
      PIO_ENV: prod-board-v0-1-alpha
      DEVICE: modbus-to-x
      KID: "bd774d27-badf-48a3-b927-a51fb08629f7"

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install PlatformIO
        run: pip install -U platformio

      - name: Set version from tag
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "APP_VERSION=$VERSION" >> $GITHUB_ENV

      - name: Build firmware
        run: pio run --project-dir "${PROJECT_DIR}" -e "${PIO_ENV}"

      - name: Prepare assets + sha256
        run: |
          BIN="${PROJECT_DIR}/.pio/build/${PIO_ENV}/firmware.bin"
          cp "$BIN" "${DEVICE}.bin"
          SHA256="$(sha256sum "${DEVICE}.bin" | awk '{print $1}')"
          echo "SHA256=$SHA256" >> $GITHUB_ENV

      - name: Load signing key
        run: |
          printf "%s" "${{ secrets.OTA_SIGNING_KEY_PEM }}" > ota_signing.key
          chmod 600 ota_signing.key

      - name: Create manifest and signature
        run: |
          URL="https://github.com/${GITHUB_REPOSITORY}/releases/download/v${VERSION}/${DEVICE}.bin"

          PAYLOAD="${DEVICE}|${VERSION}|${SHA256}|${URL}|${KID}"
          printf "%s" "$PAYLOAD" > payload.txt
          openssl dgst -sha256 -sign ota_signing.key -out sig.bin payload.txt
          SIG_B64="$(base64 -w0 sig.bin)"
          cat > "${DEVICE}.manifest.json" <<EOF
          {
            "device": "${DEVICE}",
            "version": "${VERSION}",
            "url": "${URL}",
            "sha256": "${SHA256}",
            "kid": "${KID}",
            "sig": "${SIG_B64}"
          }
          EOF
      - name: Create GitHub Release + upload assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PRERELEASE=""
          if [[ "${VERSION}" == *"-"* ]]; then
            PRERELEASE="--prerelease"
          fi

          gh release create "v${VERSION}" \
            --title "v${VERSION}" \
            --generate-notes \
            $PRERELEASE \
            "${DEVICE}.bin" \
            "${DEVICE}.manifest.json"
