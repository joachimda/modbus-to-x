<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Modbus To X – Configuration</title>
    <style>
        details.card > summary { cursor: pointer; list-style: none; }
        details.card > summary::-webkit-details-marker { display: none; }
        details.card[open] { border-color: #1fa3ec; }
        details.card > summary h3 { margin-right: .25rem; }

        #dpTable th, #dpTable td { padding:6px 4px; border-bottom:1px solid #eee; }
        #dpTable input, #dpTable select { width: 100%; padding:6px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box; }
        #dpTable td:last-child { white-space:nowrap; }

        body { font-family: Arial, sans-serif; margin: 20px; background: #f9f9f9; }
        h1 { color: #1fa3ec; margin-bottom: 8px; }
        .sub { color:#666; margin-top:0; }
        .card {
            background: #fff; border-radius: 12px; padding: 16px; margin-bottom: 16px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }
        .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        label { display:block; font-weight:600; margin-bottom:4px; }
        select, input[type="text"], textarea {
            width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #ccc; box-sizing:border-box;
        }
        .switch { display:flex; align-items:center; gap:8px; }
        .btn {
            display:inline-block; background:#1fa3ec; color:#fff; padding:10px 16px; border-radius:8px;
            text-decoration:none; border:0; cursor:pointer; margin-right:8px;
        }
        .btn.secondary { background:#e0e0e0; color:#222; }

        .toolbar { display:flex; flex-wrap: wrap; gap:8px; }
        .status { margin-top:8px; color:#555; }

        textarea { min-height: 280px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
        @media (max-width: 760px) { .row { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
<h1>Modbus To X</h1>
<p class="sub">Serial &amp; Modbus Configuration</p>

<div class="card">
    <div class="toolbar">
        <button id="btnLoad" class="btn">Reload from device</button>
        <a class="btn secondary" href="/download/config" target="_blank">Download current</a>
        <a class="btn secondary" href="/download/config_example" target="_blank">Download example</a>
        <button id="btnSave" class="btn">Save to device</button>
    </div>
    <div id="status" class="status"></div>
</div>

<div class="card">
    <h3>Bus Configuration</h3>
    <div class="row">
        <div>
            <h4>RS485 Bus 1</h4>
            <label for="bus1_baud">Baud</label>
            <select id="bus1_baud"></select>

            <label for="bus1_format">Serial format</label>
            <select id="bus1_format"></select>

            <label for="bus1_term">Termination</label>
            <select id="bus1_term">
                <option value="120R">120R</option>
            </select>

            <div class="switch">
                <input type="checkbox" id="bus1_bias" />
                <label for="bus1_bias">Enable bias</label>
            </div>
        </div>
        <!--<div>
            <h4>RS485 Bus 2</h4>
            <label for="bus2_baud">Baud</label>
            <select id="bus2_baud"></select>

            <label for="bus2_format">Serial format</label>
            <select id="bus2_format"></select>

            <label for="bus2_term">Termination</label>
            <select id="bus2_term">
                <option value="120R">120R</option>
            </select>

            <div class="switch">
                <input type="checkbox" id="bus2_bias" />
                <label for="bus2_bias">Enable bias</label>
            </div>
        </div>-->
    </div>
</div>


<div class="card">
    <h3>Add Device</h3>
    <div class="row">
        <div>
            <label for="dev_name">Name</label>
            <input type="text" id="dev_name" placeholder="VentilationUnit" />

            <label for="dev_slave">Slave ID (1–247)</label>
            <input type="text" id="dev_slave" placeholder="1" />

            <label for="dev_order">Default Byte Order</label>
            <select id="dev_order">
                <option value="ABCD">ABCD</option>
                <option value="DCBA">DCBA</option>
            </select>

            <!-- Bus is fixed to 1 for now -->
            <input type="hidden" id="dev_bus" value="1" />
        </div>
        <div>
            <p class="sub">Fill in device basics, then add one or more datapoints below. When ready, click “Add Device to JSON.”</p>
            <button id="btnAddDevice" class="btn">Add Device to JSON</button>
        </div>
    </div>

    <h4 style="margin-top:14px">Datapoints</h4>
    <p class="sub">IDs are generated automatically from “device name” and “datapoint name”.</p>
    <div class="toolbar">
        <button id="btnAddDpRow" class="btn secondary">Add datapoint row</button>
        <button id="btnClearDpRows" class="btn danger">Clear all rows</button>
    </div>

    <div style="overflow:auto; margin-top:10px">
        <table id="dpTable" style="width:100%; border-collapse:collapse">
            <thead>
            <tr style="text-align:left">
                <th>Name</th>
                <th>Address</th>
                <th>No. of Registers</th>
                <th>Scale</th>
                <th>Register Type</th>
                <th>Data Type</th>
                <th>Unit</th>
                <th>Access</th>
                <th>Poll(ms)</th>
                <th>DeadBand</th>
                <th>Precision</th>
                <th></th>
            </tr>
            </thead>
            <tbody id="dpBody"></tbody>
        </table>
    </div>

    <details id="advJson" class="card" data-pref="advJsonOpen">
        <summary>
            <h3 style="display:inline">Advanced: Full JSON</h3>
            <span class="sub"> — only needed for power users</span>
        </summary>

        <div class="toolbar" style="margin-top:10px">
            <button id="btnApply" class="btn secondary">Apply editor changes</button>
            <button id="btnFormat" class="btn secondary">Format JSON</button>
        </div>

        <p class="sub">Edit full configuration (devices, datapoints, etc.). Be careful—invalid JSON will be rejected on save.</p>
        <label for="jsonBox"></label><textarea id="jsonBox" spellcheck="false"></textarea>
    </details>


    <script>
        const DP_REGISTER_TYPES = ["H","I"];
        const DP_DATA_TYPES     = ["TEXT","F32","S16","DATE"];
        const DP_ACCESS         = ["r","rw"];

        const devEls = {
            name:  document.getElementById('dev_name'),
            slave: document.getElementById('dev_slave'),
            order: document.getElementById('dev_order'),
            bus:   document.getElementById('dev_bus'),
            dpBody:document.getElementById('dpBody'),
            btnAddDpRow:   document.getElementById('btnAddDpRow'),
            btnClearDp:    document.getElementById('btnClearDpRows'),
            btnAddDevice:  document.getElementById('btnAddDevice'),
        };

        function makeSelect(options, value) {
            const sel = document.createElement('select');
            for (const o of options) {
                const opt = document.createElement('option');
                opt.value = o; opt.textContent = o;
                sel.appendChild(opt);
            }
            if (value != null) sel.value = value;
            return sel;
        }

        function mkInput(placeholder, type="text") {
            const i = document.createElement('input');
            i.type = type;
            i.placeholder = placeholder;
            return i;
        }

        function addDpRow(prefill = {}) {
            const tr = document.createElement('tr');
            const td_name = document.createElement('td'); const name = mkInput('Voltage'); name.value = prefill.name ?? ''; td_name.appendChild(name);
            const td_addr = document.createElement('td'); const addr = mkInput('1234'); addr.value = prefill.address ?? ''; td_addr.appendChild(addr);
            const td_nreg = document.createElement('td'); const nr   = mkInput('1'); nr.value = prefill.numOfRegisters ?? '1'; td_nreg.appendChild(nr);
            const td_scale= document.createElement('td'); const sc   = mkInput('1.0'); sc.value = prefill.scale ?? ''; td_scale.appendChild(sc);
            const td_reg  = document.createElement('td'); const reg  = makeSelect(DP_REGISTER_TYPES, prefill.registerType); td_reg.appendChild(reg);
            const td_type = document.createElement('td'); const typ  = makeSelect(DP_DATA_TYPES, prefill.dataType); td_type.appendChild(typ);
            const td_unit = document.createElement('td'); const unit = mkInput('V'); unit.value = prefill.unit ?? ''; td_unit.appendChild(unit);
            const td_acc  = document.createElement('td'); const acc  = makeSelect(DP_ACCESS, prefill.access); td_acc.appendChild(acc);
            const td_poll = document.createElement('td'); const poll = mkInput('1000'); poll.value = prefill.pollMs ?? ''; td_poll.appendChild(poll);
            const td_db   = document.createElement('td'); const db   = mkInput('0'); db.value = prefill.deadBand ?? ''; td_db.appendChild(db);
            const td_precision = document.createElement('td'); const precision = mkInput('1');  precision.value = prefill.precision ?? ''; td_precision.appendChild(precision);

            const td_del  = document.createElement('td');
            const delBtn  = document.createElement('button');
            delBtn.textContent = '✕';
            delBtn.className = 'btn danger';
            delBtn.style.padding = '6px 10px';
            delBtn.addEventListener('click', () => tr.remove());
            td_del.appendChild(delBtn);

            // keep references so we can read values later
            tr._cells = { name, addr, nr, sc, reg, typ, unit, acc, poll, db, precision: precision };
            tr.append(td_name, td_addr, td_nreg, td_scale, td_reg, td_type, td_unit, td_acc, td_poll, td_db, td_precision, td_del);
            devEls.dpBody.appendChild(tr);
        }
        function clearDpRows() {
            devEls.dpBody.innerHTML = '';
        }

        function readDatapoints(deviceName) {
            const rows = [...devEls.dpBody.querySelectorAll('tr')];
            const dps = [];
            for (const r of rows) {
                const c = r._cells;
                const dpName = c.name.value.trim();
                const obj = {
                    id:      makeDpId(deviceName, dpName), // auto-generated
                    name:    dpName,
                    address: Number(c.addr.value),
                    numOfRegisters: Number(c.nr.value || 1),
                    scale:   c.sc.value === '' ? undefined : Number(c.sc.value),
                    registerType: c.reg.value,
                    dataType: c.typ.value,
                    unit:    c.unit.value.trim(),
                    access:  c.acc.value,
                    pollMs:  c.poll.value === '' ? undefined : Number(c.poll.value),
                    deadBand: c.db.value === '' ? undefined : Number(c.db.value),
                    precision: c.precision.value === '' ? undefined : Number(c.precision.value),
                };

                // validation
                if (!obj.name) return { error: 'Datapoint name is required' };
                if (!obj.id)   return { error: 'Generated datapoint ID is empty; check device name and datapoint name' };
                if (Number.isNaN(obj.address) || obj.address < 0 || obj.address > 65535)
                    return { error: `Address must be 0–65535 (got ${c.addr.value})` };
                if (Number.isNaN(obj.numOfRegisters) || obj.numOfRegisters < 1 || obj.numOfRegisters > 125)
                    return { error: `#Regs must be 1–125 (got ${c.nr.value})` };
                if (!DP_REGISTER_TYPES.includes(obj.registerType)) return { error: 'Invalid register type' };
                if (!DP_DATA_TYPES.includes(obj.dataType))         return { error: 'Invalid data type' };
                if (!DP_ACCESS.includes(obj.access))               return { error: 'Invalid access' };

                // prune undefined for tidy JSON
                for (const k of Object.keys(obj)) if (obj[k] === undefined || obj[k] === '') delete obj[k];
                dps.push(obj);
            }
            return { dps };
        }
        function slug(s) {
            return String(s || '')
                .trim()
                .toLowerCase()
                .replace(/[^a-z0-9]+/g, '_')   // non-alphanumerics -> _
                .replace(/^_+|_+$/g, '')       // trim leading/trailing _
                .replace(/_+/g, '_');          // collapse __ to _
        }

        function makeDpId(deviceName, dpName) {
            const d = slug(deviceName);
            const n = slug(dpName);
            return d && n ? `${d}.${n}` : '';
        }
        function buildDeviceFromForm() {
            const name = devEls.name.value.trim();
            const slave = Number(devEls.slave.value);
            const byteOrder = devEls.order.value;
            const busId = Number(devEls.bus.value || 1);

            if (!name) return { error: 'Device name is required' };
            if (Number.isNaN(slave) || slave < 1 || slave > 247) return { error: 'Slave ID must be 1–247' };
            if (!['ABCD','DCBA'].includes(byteOrder)) return { error: 'Invalid byte order' };
            if (busId !== 1) return { error: 'Only bus1 supported right now' };

            const { dps, error } = readDatapoints(name);
            if (error) return { error };

            // Optional: detect duplicate IDs within the new device (just in case)
            const seen = new Set();
            for (const dp of dps) {
                if (seen.has(dp.id)) return { error: `Duplicate datapoint id generated: ${dp.id}` };
                seen.add(dp.id);
            }

            return {
                device: {
                    name,
                    busId,
                    slaveId: slave,
                    defaultByteOrder: byteOrder,
                    dataPoints: dps || []
                }
            };
        }
        function addDeviceToJson() {
            let cfg;
            try {
                cfg = JSON.parse(els.jsonBox.value || '{}');
            } catch (e) {
                setStatus('Invalid JSON in editor. Fix it before adding device. ' + e.message, 'err');
                return;
            }

            const built = buildDeviceFromForm();
            if (built.error) { setStatus(built.error, 'err'); return; }

            if (!Array.isArray(cfg.devices)) cfg.devices = [];
            cfg.devices.push(built.device);

            // ensure required root fields exist (keep it gentle)
            if (!cfg.version) cfg.version = 1;
            if (!cfg.bus1) {
                cfg.bus1 = {
                    baud: 9600, serialFormat: '8N1', termination: '120R', enableBias: true
                };
            }

            els.jsonBox.value = JSON.stringify(cfg, null, 2);
            setStatus(`Device "${built.device.name}" added to JSON (bus ${built.device.busId}).`, 'ok');

            // optional: clear device form for next entry
            devEls.name.value = '';
            devEls.slave.value = '';
            devEls.order.value = 'ABCD';
            clearDpRows();
            addDpRow(); // keep one fresh row ready
        }

        // Wire up buttons
        devEls.btnAddDpRow.addEventListener('click', () => addDpRow());
        devEls.btnClearDp.addEventListener('click', () => clearDpRows());
        devEls.btnAddDevice.addEventListener('click', addDeviceToJson);

        // Start with one datapoint row
        addDpRow();

        const BAUDS = [1200,2400,4800,9600,19200,38400,57600,115200,230400,460800,921600];
        const SERIAL_FORMATS = [
            "5N1","6N1","7N1","8N1","5N2","6N2","7N2","8N2",
            "5E1","6E1","7E1","8E1","5E2","6E2","7E2","8E2",
            "5O1","6O1","7O1","8O1","5O2","6O2","7O2","8O2"
        ];

        const els = {
            bus1_baud:  document.getElementById('bus1_baud'),
            bus1_format:document.getElementById('bus1_format'),
            bus1_term:  document.getElementById('bus1_term'),
            bus1_bias:  document.getElementById('bus1_bias'),
            bus2_baud:  9600,
            bus2_format: "8N1",
            bus2_term:  "120R",
            bus2_bias:  false,
            jsonBox:    document.getElementById('jsonBox'),
            status:     document.getElementById('status'),
            btnLoad:    document.getElementById('btnLoad'),
            btnApply:   document.getElementById('btnApply'),
            btnFormat:  document.getElementById('btnFormat'),
            btnSave:    document.getElementById('btnSave'),
        };

        function setStatus(msg, cls='') {
            els.status.textContent = msg;
            els.status.className = `status ${cls}`;
        }

        function fillSelect(select, values) {
            select.innerHTML = '';
            for (const v of values) {
                const opt = document.createElement('option');
                opt.value = v; opt.textContent = v;
                select.appendChild(opt);
            }
        }

        function applyBusesToForm(cfg) {
            if (cfg.bus1) {
                els.bus1_baud.value   = String(cfg.bus1.baud ?? '');
                els.bus1_format.value = cfg.bus1.serialFormat ?? '';
                els.bus1_term.value   = cfg.bus1.termination ?? '120R';
                els.bus1_bias.checked = !!cfg.bus1.enableBias;
            }
            if (cfg.bus2) {
                els.bus2_baud.value   = String(cfg.bus2.baud ?? '');
                els.bus2_format.value = cfg.bus2.serialFormat ?? '';
                els.bus2_term.value   = cfg.bus2.termination ?? '120R';
                els.bus2_bias.checked = !!cfg.bus2.enableBias;
            }
        }

        function applyFormToBuses(cfg) {
            cfg.bus1 = cfg.bus1 || {};
            cfg.bus1.baud         = Number(els.bus1_baud.value);
            cfg.bus1.serialFormat = els.bus1_format.value;
            cfg.bus1.termination  = els.bus1_term.value;
            cfg.bus1.enableBias   = !!els.bus1_bias.checked;

            cfg.bus2 = cfg.bus2 || {};
            cfg.bus2.baud         = Number(els.bus2_baud.value);
            cfg.bus2.serialFormat = els.bus2_format.value;
            cfg.bus2.termination  = els.bus2_term.value;
            cfg.bus2.enableBias   = !!els.bus2_bias.checked;
        }

        function pretty(json) {
            return JSON.stringify(json, null, 2);
        }

        (function() {
            const det = document.getElementById('advJson');
            const key = det?.dataset?.pref || 'advJsonOpen';
            if (!det) return;

            // restore
            try { det.open = localStorage.getItem(key) === '1'; } catch(e) {}

            // persist on toggle
            det.addEventListener('toggle', () => {
                try { localStorage.setItem(key, det.open ? '1' : '0'); } catch(e) {}
            });
        })();

        async function loadConfig() {
            setStatus('Loading configuration...', '');
            let resp = await fetch('/download/config', { cache: 'no-store' });
            if (!resp.ok) {
                // Fallback to example
                resp = await fetch('/download/config_example', { cache: 'no-store' });
                if (!resp.ok) {
                    setStatus('Failed to load configuration (and example).', 'err');
                    return;
                } else {
                    setStatus('Loaded example configuration (no user config yet).', 'warn');
                }
            } else {
                setStatus('Loaded current configuration from device.', 'ok');
            }

            try {
                const cfg = await resp.json();
                els.jsonBox.value = pretty(cfg);
                applyBusesToForm(cfg);
            } catch (e) {
                setStatus('Error parsing JSON: ' + e.message, 'err');
            }
        }

        function applyEditorChanges() {
            try {
                const cfg = JSON.parse(els.jsonBox.value);
                applyBusesToForm(cfg);
                setStatus('Editor applied to form.', 'ok');
            } catch (e) {
                setStatus('Invalid JSON: ' + e.message, 'err');
            }
        }

        function updateEditorFromForm() {
            try {
                const cfg = JSON.parse(els.jsonBox.value || '{}');
                applyFormToBuses(cfg);
                els.jsonBox.value = pretty(cfg);
                setStatus('Form changes applied to JSON.', 'ok');
            } catch (e) {
                setStatus('Invalid JSON before applying form: ' + e.message, 'err');
            }
        }

        async function saveToDevice() {
            let cfg;
            try {
                cfg = JSON.parse(els.jsonBox.value);
            } catch (e) {
                setStatus('Cannot save: JSON is invalid. ' + e.message, 'err');
                return;
            }

            // Minimal sanity checks (optional – extend as desired)
            if (!cfg.version) cfg.version = 1;

            const blob = new Blob([pretty(cfg)], { type: 'application/json' });
            const form = new FormData();
            // Field name can be anything; your server handler writes whatever to /config.json
            form.append('file', blob, 'config.json');

            setStatus('Uploading config...', '');
            try {
                const resp = await fetch('/upload', { method: 'POST', body: form });
                if (resp.ok) {
                    setStatus('Config uploaded successfully. The device will use it after restart or when your firmware loads it.', 'ok');
                } else {
                    const t = await resp.text();
                    setStatus('Upload failed: ' + t, 'err');
                }
            } catch (e) {
                setStatus('Upload error: ' + e.message, 'err');
            }
        }

        // Init
        fillSelect(els.bus1_baud, BAUDS);
        //fillSelect(els.bus2_baud, BAUDS);
        fillSelect(els.bus1_format, SERIAL_FORMATS);
        //fillSelect(els.bus2_format, SERIAL_FORMATS);

        els.btnLoad.addEventListener('click', loadConfig);
        els.btnApply.addEventListener('click', applyEditorChanges);
        els.btnFormat.addEventListener('click', () => {
            try {
                els.jsonBox.value = pretty(JSON.parse(els.jsonBox.value));
                setStatus('JSON formatted.', 'ok');
            } catch (e) { setStatus('Invalid JSON: ' + e.message, 'err'); }
        });
        els.btnSave.addEventListener('click', saveToDevice);

        for (const id of ['bus1_baud','bus1_format','bus1_term','bus1_bias',/*'bus2_baud','bus2_format','bus2_term','bus2_bias'*/]) {
            document.getElementById(id).addEventListener('change', updateEditorFromForm);
        }
        loadConfig();
    </script>
</div>
</body>
</html>
