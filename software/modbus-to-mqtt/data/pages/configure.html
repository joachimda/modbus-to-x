<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/html" xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Modbus To X – Configuration</title>
    <link rel="stylesheet" href="/style.css" />
    <script type="importmap">
        {
          "imports": {
            "app": "/js/app.js",
            "configure": "/js/pages/configure.js"
          }
        }
    </script>
</head>
<body class="configure" data-page="configure_v2">
<div class="page">
    <header style="display:flex;justify-content:space-between;align-items:center;gap:1rem;flex-wrap:wrap;">
        <div>
            <h1>Configure Modbus</h1>
            <div class="muted">Set up buses, devices, and datapoints. Changes are saved to SPIFFS and can be applied live.</div>
        </div>
        <nav class="toolbar">
            <a class="btn" href="/">Home</a>
            <button class="btn" id="btn-validate">Validate</button>
            <button class="btn" id="btn-export">Export JSON</button>
            <label class="btn" for="file-import" title="Import JSON">Import JSON</label>
            <input id="file-import" type="file" accept="application/json" style="display:none" />
            <button class="btn" id="btn-reload">Reload</button>
            <button class="btn primary" id="btn-save-apply">Save & Apply</button>
        </nav>
    </header>

    <section class="layout">
        <!-- Left: tree -->
        <aside class="card sidebar">
            <div class="tree">
                <div class="header">
                    <strong>Configuration</strong>
                    <!-- removed global +buttons; they move to better places -->
                </div>
                <label for="tree-search"></label>
                <input id="tree-search" class="tree-search" placeholder="Search devices/datapoints…"/>
                <div id="tree-list" class="list"></div>

                <div class="sidebar-footer">
                    <button class="btn" id="btn-add-device">+ Add Device</button>
                </div>
            </div>
        </aside>
        <!-- Right: editor -->
        <main class="card scroll">
            <div id="editor-placeholder" class="muted">Select Device or Datapoint to edit, or click the Bus to adjust serial/pins.</div>

            <!-- Bus editor  -->
            <div id="editor-bus" style="display:none">
                <h3>Edit RS485 Bus </h3>
                <div class="kvs kvs-4">
                    <!-- BAUD Rate -->
                    <div>Baud</div>
                    <label for="bus-baud"></label>
                    <input id="bus-baud" type="number" step="1" min="1200" />

                    <!-- Parity -->
                    <div>Parity</div>
                    <label for="bus-serial-parity"></label>
                    <select id="bus-serial-parity">
                        <option value="N">None</option>
                        <option value="O">Odd</option>
                        <option value="E">Even</option>
                    </select>

                    <!-- Stop Bits -->
                    <div>Stop Bits</div>
                    <label for="bus-serial-stop-bits"></label>
                    <select id="bus-serial-stop-bits">
                        <option value="1">1</option>
                        <option value="2">2</option>
                    </select>

                    <!-- Data Bits -->
                    <div>Data Bits</div>
                    <label for="bus-data-bits"></label>
                    <select id="bus-data-bits">
                        <option value="8">8</option>
                        <option value="7">7</option>
                    </select>
                </div>
                <div class="divider"></div>
                <div class="hstack">
                    <button class="btn" id="btn-bus-save">Save</button>
                    <span class="hint">Bus is fixed across all configured devices; .</span>
                </div>
            </div>

            <!-- Device editor -->
            <div id="editor-device" style="display:none">
                <h3 class="with-actions">
                    Edit Device
                </h3>
                <span class="spacer"></span>
                <button class="btn" id="btn-dev-add-dp">+ Datapoint</button>

                <div class="kvs kvs-2">
                    <div>Device Name</div>
                    <label for="dev-name"></label><input id="dev-name"/>
                    <div>Slave ID</div>
                    <label for="dev-slave"></label><input id="dev-slave" type="number" min="1" max="247"/>
                    <div>Notes</div>
                    <label for="dev-notes"></label><input id="dev-notes" class="full" placeholder="Optional"/>
                </div>
                <div class="divider"></div>

                <!-- Datapoints -->
                <h4>Datapoints</h4>
                <table class="table" id="dev-dp-table">
                    <thead>
                    <tr>
                        <th>ID</th><th>Name</th><th>Function</th><th>Address</th><th>Type</th><th></th>
                    </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <div class="divider"></div>
                <div class="hstack">
                    <button class="btn" id="btn-dev-save">Save</button>
                    <button class="btn danger" id="btn-dev-delete">Delete Device</button>
                </div>
            </div>

            <!-- Datapoint editor -->
            <div id="editor-dp" style="display:none">
                <h3 class="with-actions">Edit Datapoint <span class="spacer"></span><span id="dp-autoid" class="mono pill">—</span></h3>
                <div class="kvs kvs-3">
                    <div>Device</div>
                    <label for="dp-device"></label><select id="dp-device"></select>
                    <div>Datapoint Name</div>
                    <label for="dp-name"></label><input id="dp-name"/>
                    <div>Function</div>
                    <label for="dp-func"></label>
                    <select id="dp-func">
                        <option value=1>1 (READ_COIL)</option>
                        <option value=2>2 (READ_DISCRETE)</option>
                        <option value=3>3 (READ_HREG)</option>
                        <option value=4>4 (READ_IREG)</option>
                        <option value=5>5 (WRITE_COIL)</option>
                        <option value=6>6 (WRITE_HREG)</option>
                    </select>
                    <div>Address</div>
                    <label for="dp-addr"></label>
                    <input id="dp-addr" type="number" min="0" step="1"/>
                    <div>Length</div>
                    <label for="dp-len"></label>
                    <input id="dp-len" type="number" min="1" step="1" value="1"/>

                    <!-- Data Type -->
                    <div>Data Type</div>
                    <label for="dp-type"></label>
                    <select id="dp-type">
                        <option value="TEXT">TEXT</option>
                        <option value="int16">int16</option>
                        <option value="int32">int32</option>
                        <option value="int64">int64</option>
                        <option value="uint16">uint16</option>
                        <option value="uint32">uint32</option>
                        <option value="uint64">uint64</option>
                        <option value="float32">float32</option>
                    </select>

                    <div>Scale</div>
                    <label for="dp-scale"></label>
                    <input id="dp-scale" type="number" step="0.0001" value="1"/>

                    <div>Unit</div>
                    <label for="dp-unit"></label>
                    <input id="dp-unit" placeholder="e.g. °C, Pa, %"/>

                    <div>MQTT Topic</div>
                    <label for="dp-topic"></label>
                    <input id="dp-topic" class="full" placeholder="optional; defaults to /mbx/&lt;id&gt;"/>
                </div>

                <div class="divider"></div>
                <div class="hstack">
                    <button class="btn" id="btn-dp-test-read">Test Read</button>
                    <button class="btn" id="btn-dp-test-write">Test Write</button>
                    <label for="dp-test-value"></label>
                    <input id="dp-test-value" class="mono" placeholder="value for write" />
                    <span id="dp-test-result" class="hint"></span>
                </div>

                <div class="divider"></div>
                <div class="hstack">
                    <button class="btn" id="btn-dp-save">Save</button>
                    <button class="btn danger" id="btn-dp-delete">Delete Datapoint</button>
                </div>
            </div>
        </main>
    </section>
</div>

<!-- Save & Apply confirmation modal -->
<div id="modal-confirm" class="modal-backdrop" style="display:none">
    <div class="modal card">
        <h3 class="with-actions">Save & Apply <span class="spacer"></span><button class="btn ghost" id="btn-confirm-close">✕</button></h3>
        <p class="muted">Review and back up your current configuration before applying changes.</p>
        <div class="hstack">
            <button class="btn" id="btn-download-backup">Download Current Config</button>
        </div>
        <div class="divider"></div>
        <details>
            <summary>Show generated JSON</summary>
            <pre id="json-preview" class="code" style="max-height:320px; overflow:auto;"></pre>
        </details>
        <div class="actions" style="justify-content:flex-end">
            <button class="btn ghost" id="btn-cancel-apply">Cancel</button>
            <button class="btn primary" id="btn-approve-apply">Approve & Apply</button>
        </div>
    </div>
    
</div>
    <script type="module">
        import 'app';
        import 'configure';
    </script>
</body>
</html>
